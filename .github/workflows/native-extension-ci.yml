name: Native Extension CI

on:
    pull_request:
    push:
        branches:
            - master
    workflow_dispatch:

jobs:
    build-and-test:
        name: Build and test on ${{ matrix.os }} / py${{ matrix.python-version }}
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os:
                    - ubuntu-latest
                    - macos-latest
                python-version:
                    - "3.11"

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Install uv
              uses: astral-sh/setup-uv@v4

            - name: Install native dependencies (Linux)
              if: runner.os == 'Linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libeigen3-dev libxsimd-dev

            - name: Install native dependencies (macOS)
              if: runner.os == 'macOS'
              run: |
                  brew update
                  brew install eigen xsimd

            - name: Sync Python dependencies
              run: uv sync --dev

            - name: Install build tooling
              run: uv pip install setuptools wheel pybind11

            - name: Build native extensions
              run: uv run python setup.py build_ext --inplace

            - name: Smoke test native imports and warning regression
              run: |
                  uv run python - <<'PY'
                  import contextlib
                  import io

                  err = io.StringIO()
                  with contextlib.redirect_stderr(err):
                      from grad.kernels import cpu_kernel
                      from grad.autograd import operations

                  warning = "Could not import cpu_kernel extension"
                  stderr_text = err.getvalue()
                  if warning in stderr_text:
                      raise RuntimeError(f"Unexpected warning during import: {stderr_text.strip()}")

                  print(cpu_kernel.__name__)
                  print(operations.__name__)
                  PY

            - name: Run Python tests
              run: |
                  uv run pytest -q \
                    tests/test_kernel_import.py \
                    tests/test_buffer.py \
                    tests/tensor_test.py \
                    tests/ops_test.py
